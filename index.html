<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="description" content="Hagius Breathing - A breathing exercise app for stress reduction and mindfulness" />
  <title>Hagius Breathing</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary-color: #214B7A;
      --secondary-color: #F28E47;
      --white-transparent-light: rgba(255, 255, 255, 0.2);
      --white-transparent-medium: rgba(255, 255, 255, 0.3);
      --white-transparent-bright: rgba(255, 255, 255, 0.4);
      --white-transparent-brighter: rgba(255, 255, 255, 0.5);
      
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      --space-16: 64px;
      
      --border-radius: 0px;
      --transition-speed: 0.3s;
      --button-spacing: var(--space-1);
      --element-height: 60px;
      --font-size-button: 0.4;
      --font-size-header: 2.4rem;
      --element-padding: var(--space-4);
      --min-button-width: 120px;
      
      --safe-bottom: calc(var(--space-5) + env(safe-area-inset-bottom));
      --safe-top: calc(var(--space-5) + env(safe-area-inset-top));
    }
    
    html {
      height: 100vh;
      overflow: hidden;
    }
    
    body {
      font-family: Helvetica, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      font-weight: bold;
      background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
      color: #fff;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      height: 100vh;
      width: 100%;
      margin: 0;
      padding-bottom: env(safe-area-inset-bottom);
      padding-top: env(safe-area-inset-top);
      overflow: hidden;
      touch-action: manipulation;
    }
    
    .loading-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease-out;
      flex-direction: column;
    }
    
    .loading-logo {
      font-size: 3rem;
      margin-bottom: var(--space-5);
    }
    
    .loading-progress {
      width: 200px;
      height: 4px;
      background: var(--white-transparent-light);
      margin-top: var(--space-5);
      overflow: hidden;
      border-radius: 2px;
    }
    
    .loading-bar {
      height: 100%;
      width: 0%;
      background: white;
      transition: width 0.3s ease;
    }
    
    .loader-text {
      text-align: center;
      font-size: calc(var(--element-height) * var(--font-size-button));
      font-weight: bold;
      margin-top: var(--space-5);
      text-transform: uppercase;
    }
    
    .app-container {
      opacity: 0;
      transition: opacity 0.5s ease-in;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    #homeScreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
      display: none;
      flex-direction: column;
      align-items: center;
      z-index: 100;
      padding: var(--safe-top) var(--space-4) calc(var(--element-height) + var(--space-4) + env(safe-area-inset-bottom)) var(--space-4);
      overflow-y: auto;
    }

    .home-logo-container {
      text-align: center;
      margin-bottom: var(--space-10);
      margin-top: var(--space-16);
      font-size: 4rem;
    }

    .welcome-text {
      font-size: 1.2rem;
      text-align: center;
      margin-bottom: var(--space-10);
      opacity: 0.9;
    }

    .home-buttons {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 480px;
      gap: var(--space-4);
    }

    .home-button {
      background: var(--white-transparent-light);
      border: none;
      color: white;
      font-weight: bold;
      font-size: calc(var(--element-height) * var(--font-size-button));
      padding: 0 var(--element-padding);
      height: var(--element-height);
      width: 100%;
      cursor: pointer;
      transition: background var(--transition-speed);
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .home-button:hover {
      background: var(--white-transparent-medium);
    }

    .quick-stats {
      margin-top: var(--space-12);
      background: var(--white-transparent-light);
      padding: var(--space-4);
      width: 100%;
      max-width: 480px;
    }

    .quick-stats h3 {
      margin-bottom: var(--space-2);
      font-size: 1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-4);
    }

    .stat-item {
      text-align: center;
    }

    .stat-number {
      font-size: 1.8rem;
      font-weight: bold;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .nav-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      z-index: 1000;
      padding: 0 0 env(safe-area-inset-bottom) 0;
      gap: var(--button-spacing);
      background: transparent;
    }

    .nav-button {
      background: var(--white-transparent-light);
      border: none;
      flex: 1;
      font-size: calc(var(--element-height) * var(--font-size-button));
      font-weight: bold;
      color: #fff;
      cursor: pointer;
      transition: background var(--transition-speed);
      height: var(--element-height);
      padding: 0 var(--element-padding);
      text-transform: uppercase;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .nav-button:hover {
      background: var(--white-transparent-bright);
    }
    
    .nav-button.active {
      background: var(--white-transparent-medium);
    }

    .nav-text {
      font-size: 0.7rem;
    }
    
    .header {
      position: fixed;
      top: var(--space-16);
      left: 0;
      right: 0;
      text-align: center;
      z-index: 10;
      transition: opacity 0.3s ease;
      margin-bottom: var(--space-10);
      font-size: 2rem;
    }
    
    .main-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      width: 100%;
    }
    
    .breathing-circle {
      width: 250px;
      height: 250px;
      border-radius: 50%;
      background: var(--white-transparent-light);
      margin: 0 auto;
      will-change: transform;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: scale(1);
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
      position: relative;
      z-index: 1;
    }
    
    .timer {
      font-size: calc(var(--element-height) * 0.4);
      font-weight: bold;
      color: rgba(255, 255, 255, 0.95);
      text-align: center;
      transition: opacity 0.15s ease-in-out;
      text-transform: uppercase;
      position: relative;
      z-index: 2;
    }
    
    .timer.fade {
      opacity: 0.3;
    }

    .session-progress-container {
      position: fixed;
      bottom: calc(var(--element-height) + var(--button-spacing) + env(safe-area-inset-bottom));
      left: 0;
      right: 0;
      width: 100%;
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .session-progress {
      width: 100%;
      height: var(--element-height);
      background: var(--white-transparent-light);
      overflow: hidden;
      cursor: pointer;
      transition: background var(--transition-speed);
      position: relative;
    }
    
    .session-progress:hover {
      background: var(--white-transparent-bright);
    }
    
    .session-progress-bar {
      height: 100%;
      background: var(--white-transparent-brighter);
      width: 0%;
      transition: width 1s linear;
      position: absolute;
      left: 0;
      top: 0;
      z-index: 1;
    }
    
    .remaining-time {
      position: absolute;
      font-size: calc(var(--element-height) * 0.4);
      font-weight: bold;
      color: white;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
    }
    
    .timer-options {
      position: fixed;
      bottom: calc(2 * var(--element-height) + 2 * var(--button-spacing) + env(safe-area-inset-bottom));
      left: 0;
      right: 0;
      display: none;
      z-index: 30;
    }
    
    .timer-option-buttons {
      display: flex;
      flex-wrap: wrap;
      width: 100%;
      gap: var(--button-spacing);
    }
    
    .timer-options button {
      background: var(--white-transparent-light);
      border: none;
      color: white;
      padding: 0 var(--element-padding);
      flex: 1 1 calc(25% - var(--button-spacing) * 3/4);
      min-width: 0;
      font-size: calc(var(--element-height) * var(--font-size-button));
      font-weight: bold;
      cursor: pointer;
      transition: background var(--transition-speed);
      height: var(--element-height);
    }
    
    @media (max-width: 600px) {
      .timer-options button {
        flex: 1 1 calc(50% - var(--button-spacing) * 1/2);
      }
    }
    
    .timer-options button:hover {
      background: var(--white-transparent-medium);
    }
    
    .timer-options button.active {
      background: var(--white-transparent-medium);
    }
    
    .button-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      z-index: 10;
      padding: 0 0 env(safe-area-inset-bottom) 0;
      gap: var(--button-spacing);
    }
    
    .bottom-button {
      background: var(--white-transparent-light);
      border: none;
      flex: 1;
      font-size: calc(var(--element-height) * var(--font-size-button));
      font-weight: bold;
      color: #fff;
      cursor: pointer;
      transition: background var(--transition-speed);
      height: var(--element-height);
      padding: 0 var(--element-padding);
      text-transform: uppercase;
    }
    
    .bottom-button:hover {
      background: var(--white-transparent-bright);
    }
    
    .technique-panel {
      position: fixed;
      bottom: calc(2 * var(--element-height) + 2 * var(--button-spacing) + env(safe-area-inset-bottom));
      left: 0;
      right: 0;
      display: none;
      z-index: 50;
    }
    
    .technique-buttons {
      display: flex;
      flex-wrap: wrap;
      width: 100%;
      gap: var(--button-spacing);
    }
    
    .technique-panel button {
      flex: 1 1 calc(50% - var(--button-spacing) * 1/2);
      min-width: 80px;
      background: var(--white-transparent-light);
      border: none;
      color: white;
      padding: 0 var(--element-padding);
      font-size: calc(var(--element-height) * var(--font-size-button));
      font-weight: bold;
      cursor: pointer;
      transition: background var(--transition-speed);
      text-transform: capitalize;
      height: var(--element-height);
    }
    
    .technique-panel button:hover {
      background: var(--white-transparent-medium);
    }
    
    .toast-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: var(--space-4);
      z-index: 9000;
      pointer-events: none;
    }
    
    .toast {
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: var(--space-3) var(--space-5);
      border-radius: 30px;
      margin-bottom: var(--space-2);
      max-width: 80%;
      text-align: center;
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.3s, transform 0.3s;
    }
    
    .toast.visible {
      opacity: 1;
      transform: translateY(0);
    }
    
    @media (min-width: 768px) {
      :root {
        --element-height: 70px;
      }
      .breathing-circle { 
        width: 350px; 
        height: 350px; 
      }
    }
    
    @media (max-width: 480px) {
      :root {
        --element-height: 50px;
      }
      .breathing-circle { 
        width: 250px; 
        height: 250px; 
      }
    }
  </style>
</head>
<body>
  <div id="loadingContainer" class="loading-container">
    <div>
      <div class="loading-logo">🌬️</div>
      <div class="loader-text">Loading Breathing App...</div>
      <div class="loading-progress">
        <div id="loadingBar" class="loading-bar"></div>
      </div>
    </div>
  </div>

  <div id="toastContainer" class="toast-container"></div>

  <div id="homeScreen" class="screen">
    <div class="home-logo-container">🌬️</div>
    <p class="welcome-text">Your daily companion for mindful breathing and stress reduction</p>
    <div class="home-buttons">
      <button id="startBreathingBtn" class="home-button">Start Breathing</button>
      <button id="programsBtn" class="home-button">Programs</button>
      <button id="profileBtn" class="home-button">Profile</button>
    </div>
    <div class="quick-stats">
      <h3>Your Progress</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-number">0</div>
          <div class="stat-label">Sessions</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">0</div>
          <div class="stat-label">Minutes</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">0</div>
          <div class="stat-label">Day Streak</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">0</div>
          <div class="stat-label">Programs</div>
        </div>
      </div>
    </div>
  </div>

  <div id="appContainer" class="app-container">
    <div class="header">
      <div>🌬️ Hagius</div>
    </div>
    
    <div class="main-container">
      <div id="breathingCircle" class="breathing-circle">
        <div id="timer" class="timer">EXHALE</div>
      </div>
    </div>
    
    <div id="timerOptions" class="timer-options">
      <div class="timer-option-buttons">
        <button data-duration="5">5 MIN</button>
        <button data-duration="10">10 MIN</button>
        <button data-duration="15">15 MIN</button>
        <button data-duration="20">20 MIN</button>
      </div>
    </div>
    
    <div id="techniquePanel" class="technique-panel">
      <div class="technique-buttons">
        <button data-technique="resonance">Resonance</button>
        <button data-technique="478">4-7-8</button>
        <button data-technique="box">Box</button>
        <button data-technique="physio-sigh">Sighing</button>
      </div>
    </div>
    
    <div class="session-progress-container">
      <div id="progressBar" class="session-progress">
        <div id="progressIndicator" class="session-progress-bar"></div>
        <div id="remainingTime" class="remaining-time">5:00</div>
      </div>
    </div>
    
    <div class="button-container">
      <button id="techniqueButton" class="bottom-button">Technique</button>
      <button id="focusButton" class="bottom-button">Focus</button>
      <button id="homeButton" class="bottom-button">Home</button>
    </div>
  </div>
  
  <div class="nav-container" id="navContainer">
    <button id="navHome" class="nav-button active">
      <div class="nav-text">Home</div>
    </button>
    <button id="navBreathing" class="nav-button">
      <div class="nav-text">Breathe</div>
    </button>
    <button id="navPrograms" class="nav-button">
      <div class="nav-text">Programs</div>
    </button>
    <button id="navProfile" class="nav-button">
      <div class="nav-text">Profile</div>
    </button>
  </div>
  
  <script>
    (function() {
      const BREATHING_PATTERNS = {
        resonance: [
          { label: 'Inhale', duration: 5.5 },
          { label: 'Exhale', duration: 5.5 }
        ],
        box: [
          { label: 'Inhale', duration: 4 },
          { label: 'Hold', duration: 4 },
          { label: 'Exhale', duration: 4 },
          { label: 'Hold', duration: 4 }
        ],
        '478': [
          { label: 'Inhale', duration: 4 },
          { label: 'Hold', duration: 7 },
          { label: 'Exhale', duration: 8 }
        ],
        'physio-sigh': [
          { label: 'Inhale', duration: 1 },
          { label: 'Inhale2', duration: 0.25 },
          { label: 'Exhale', duration: 2 }
        ]
      };
      
      const SCREENS = {
        HOME: 'homeScreen',
        BREATHING: 'appContainer'
      };
      
      const state = {
        currentScreen: SCREENS.HOME,
        currentPattern: BREATHING_PATTERNS.resonance,
        currentPhaseIndex: 0,
        phaseStartTime: 0,
        phaseEndTime: 0,
        animationFrameId: null,
        currentScale: 1.0,
        sessionDuration: 5 * 60,
        sessionStartTime: 0,
        sessionElapsed: 0,
        sessionIntervalId: null,
        elements: {}
      };
      
      const utils = {
        showToast: (message, duration = 3000) => {
          const toast = document.createElement('div');
          toast.className = 'toast';
          toast.textContent = message;
          state.elements.toastContainer.appendChild(toast);
          void toast.offsetWidth;
          toast.classList.add('visible');
          setTimeout(() => {
            toast.classList.remove('visible');
            setTimeout(() => toast.remove(), 300);
          }, duration);
        },
        formatTime: (seconds) => {
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
      };
      
      function navigateTo(screenId) {
        if (state.currentScreen === SCREENS.BREATHING && screenId !== SCREENS.BREATHING) {
          pauseBreathingSession();
        }
        
        Object.values(SCREENS).forEach(screen => {
          const element = document.getElementById(screen);
          if (element) element.style.display = 'none';
        });
        
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) {
          targetScreen.style.display = screenId === SCREENS.HOME ? 'flex' : 'block';
          state.currentScreen = screenId;
          updateNavigation(screenId);
          
          if (screenId === SCREENS.BREATHING) {
            resumeBreathingSession();
          }
        }
      }
      
      function updateNavigation(screenId) {
        const navMapping = {
          [SCREENS.HOME]: 'navHome',
          [SCREENS.BREATHING]: 'navBreathing'
        };
        
        document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
        const activeNavId = navMapping[screenId];
        if (activeNavId) {
          const activeNav = document.getElementById(activeNavId);
          if (activeNav) activeNav.classList.add('active');
        }
      }
      
      const handlers = {
        toggleTechniquePanel: () => {
          const panel = state.elements.techniquePanel;
          state.elements.timerOptions.style.display = 'none';
          panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        },
        selectTechnique: (btn) => {
          const selected = btn.getAttribute('data-technique');
          const newPattern = BREATHING_PATTERNS[selected];
          if (!newPattern) return;
          
          state.currentPattern = newPattern;
          state.elements.techniqueButton.textContent = btn.textContent;
          resetBreathing();
          state.elements.techniquePanel.style.display = 'none';
          utils.showToast(`Switched to ${btn.textContent} breathing`, 2000);
        },
        toggleTimerOptions: () => {
          const timerOptions = state.elements.timerOptions;
          state.elements.techniquePanel.style.display = 'none';
          timerOptions.style.display = timerOptions.style.display === 'block' ? 'none' : 'block';
        },
        selectTimerOption: (btn) => {
          document.querySelectorAll('.timer-options button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          const minutes = parseInt(btn.getAttribute('data-duration'));
          state.sessionDuration = minutes * 60;
          state.sessionElapsed = 0;
          
          if (state.sessionIntervalId) {
            clearInterval(state.sessionIntervalId);
            state.sessionIntervalId = null;
          }
          
          updateRemainingTimeDisplay();
          startSessionTimer();
          state.elements.timerOptions.style.display = 'none';
          utils.showToast(`Session set to ${minutes} minutes`);
        },
        goToHomeScreen: () => navigateTo(SCREENS.HOME),
        goToBreathingScreen: () => navigateTo(SCREENS.BREATHING)
      };
      
      function cacheElements() {
        state.elements = {
          appContainer: document.getElementById('appContainer'),
          homeScreen: document.getElementById('homeScreen'),
          loadingContainer: document.getElementById('loadingContainer'),
          loadingBar: document.getElementById('loadingBar'),
          breathingCircle: document.getElementById('breathingCircle'),
          techniqueButton: document.getElementById('techniqueButton'),
          focusButton: document.getElementById('focusButton'),
          homeButton: document.getElementById('homeButton'),
          techniquePanel: document.getElementById('techniquePanel'),
          timerDisplay: document.getElementById('timer'),
          progressBar: document.getElementById('progressBar'),
          progressIndicator: document.getElementById('progressIndicator'),
          timerOptions: document.getElementById('timerOptions'),
          remainingTime: document.getElementById('remainingTime'),
          toastContainer: document.getElementById('toastContainer'),
          navHome: document.getElementById('navHome'),
          navBreathing: document.getElementById('navBreathing'),
          navPrograms: document.getElementById('navPrograms'),
          navProfile: document.getElementById('navProfile'),
          startBreathingBtn: document.getElementById('startBreathingBtn'),
          programsBtn: document.getElementById('programsBtn'),
          profileBtn: document.getElementById('profileBtn')
        };
      }
      
      function simulateLoading() {
        let progress = 0;
        const interval = setInterval(() => {
          progress += 10;
          if (state.elements.loadingBar) {
            state.elements.loadingBar.style.width = `${progress}%`;
          }
          
          if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
              state.elements.loadingContainer.style.opacity = '0';
              setTimeout(() => {
                state.elements.loadingContainer.style.display = 'none';
              }, 500);
              
              state.elements.appContainer.style.opacity = '1';
              navigateTo(SCREENS.HOME);
            }, 300);
          }
        }, 100);
      }
      
      function attachEventListeners() {
        state.elements.techniqueButton.addEventListener('click', handlers.toggleTechniquePanel);
        
        const techniqueBtns = state.elements.techniquePanel.querySelectorAll('button');
        techniqueBtns.forEach(btn => {
          btn.addEventListener('click', () => handlers.selectTechnique(btn));
        });
        
        state.elements.progressBar.addEventListener('click', handlers.toggleTimerOptions);
        
        const timerOptionBtns = document.querySelectorAll('.timer-options button');
        timerOptionBtns.forEach(btn => {
          btn.addEventListener('click', () => handlers.selectTimerOption(btn));
        });
        
        state.elements.navHome.addEventListener('click', handlers.goToHomeScreen);
        state.elements.navBreathing.addEventListener('click', handlers.goToBreathingScreen);
        state.elements.homeButton.addEventListener('click', handlers.goToHomeScreen);
        state.elements.startBreathingBtn.addEventListener('click', handlers.goToBreathingScreen);
        
        state.elements.navPrograms.addEventListener('click', () => utils.showToast('Programs coming soon'));
        state.elements.navProfile.addEventListener('click', () => utils.showToast('Profile coming soon'));
        state.elements.programsBtn.addEventListener('click', () => utils.showToast('Programs coming soon'));
        state.elements.profileBtn.addEventListener('click', () => utils.showToast('Profile coming soon'));
      }
      
      function startBreathing() {
        state.currentPhaseIndex = 0;
        startPhase(state.currentPhaseIndex);
      }
      
      function pauseBreathingSession() {
        if (state.animationFrameId) {
          cancelAnimationFrame(state.animationFrameId);
          state.animationFrameId = null;
        }
        if (state.sessionIntervalId) {
          clearInterval(state.sessionIntervalId);
          state.sessionIntervalId = null;
        }
      }
      
      function resumeBreathingSession() {
        if (state.animationFrameId === null) {
          startBreathing();
        }
        if (state.sessionIntervalId === null) {
          startSessionTimer();
        }
      }
      
      function resetBreathing() {
        if (state.animationFrameId) {
          cancelAnimationFrame(state.animationFrameId);
          state.animationFrameId = null;
        }
        state.currentScale = 1.0;
        startPhase(0);
      }
      
      function startPhase(phaseIndex) {
        const phase = state.currentPattern[phaseIndex];
        if (!phase) return;
        
        state.currentPhaseIndex = phaseIndex;
        state.phaseStartTime = performance.now();
        state.phaseEndTime = state.phaseStartTime + (phase.duration * 1000);
        
        applyPhaseAnimation(phase.label, phase.duration);
        
        if (state.elements.timerDisplay) {
          state.elements.timerDisplay.classList.add('fade');
          setTimeout(() => {
            let displayLabel = phase.label === 'Inhale2' ? 'Inhale' : phase.label;
            displayLabel = displayLabel.charAt(0).toUpperCase() + displayLabel.slice(1);
            state.elements.timerDisplay.textContent = displayLabel;
            state.elements.timerDisplay.classList.remove('fade');
          }, 150);
        }
        
        if (state.animationFrameId) {
          cancelAnimationFrame(state.animationFrameId);
        }
        
        function updatePhase(timestamp) {
          if (state.currentScreen !== SCREENS.BREATHING) return;
          
          if (timestamp >= state.phaseEndTime) {
            const nextIndex = (state.currentPhaseIndex + 1) % state.currentPattern.length;
            startPhase(nextIndex);
            return;
          }
          
          state.animationFrameId = requestAnimationFrame(updatePhase);
        }
        
        state.animationFrameId = requestAnimationFrame(updatePhase);
      }
      
      function applyPhaseAnimation(label, duration) {
        if (!state.elements.breathingCircle) return;
        
        let nextScale = state.currentScale;
        switch (label.toLowerCase()) {
          case 'inhale': nextScale = 1.5; break;
          case 'inhale2': nextScale = 1.8; break;
          case 'exhale': nextScale = 0.6; break;
          case 'hold': nextScale = state.currentScale; break;
          default: nextScale = 1.0;
        }
        
        const circle = state.elements.breathingCircle;
        circle.style.transition = `transform ${duration}s cubic-bezier(0.4, 0.0, 0.2, 1)`;
        circle.style.transform = `scale(${nextScale})`;
        state.currentScale = nextScale;
      }
      
      function startSessionTimer() {
        if (state.sessionIntervalId) {
          clearInterval(state.sessionIntervalId);
        }
        
        state.sessionStartTime = Date.now();
        state.sessionElapsed = 0;
        
        if (state.elements.progressIndicator) {
          state.elements.progressIndicator.style.transition = '';
          state.elements.progressIndicator.style.width = '0%';
        }
        
        updateProgressBar();
        
        state.sessionIntervalId = setInterval(() => {
          const now = Date.now();
          state.sessionElapsed = Math.floor((now - state.sessionStartTime) / 1000);
          updateProgressBar();
          
          if (state.sessionElapsed >= state.sessionDuration) {
            endSession();
          }
        }, 1000);
      }
      
      function updateProgressBar() {
        if (!state.elements.progressIndicator) return;
        
        const progressPercent = (state.sessionElapsed / state.sessionDuration) * 100;
        state.elements.progressIndicator.style.width = `${progressPercent}%`;
        updateRemainingTimeDisplay();
      }
      
      function updateRemainingTimeDisplay() {
        if (!state.elements.remainingTime) return;
        
        const remainingSeconds = Math.max(0, state.sessionDuration - state.sessionElapsed);
        state.elements.remainingTime.textContent = utils.formatTime(remainingSeconds);
      }
      
      function endSession() {
        if (state.sessionIntervalId) {
          clearInterval(state.sessionIntervalId);
          state.sessionIntervalId = null;
        }
        
        state.elements.progressIndicator.style.width = '100%';
        utils.showToast('Session Complete!', 3000);
        
        setTimeout(() => {
          state.sessionElapsed = 0;
          state.elements.progressIndicator.style.transition = '';
          state.elements.progressIndicator.style.width = '0%';
          startSessionTimer();
        }, 2000);
      }
      
      function init() {
        cacheElements();
        simulateLoading();
        attachEventListeners();
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
