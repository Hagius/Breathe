<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Important for iOS safe-area usage -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Hagius Breathing</title>
  <style>
    /* Reset & Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(to top, #F28E47, #214B7A);
      color: #fff;
      position: relative;
      /* Apply safe-area insets (for iPhone X and newer) */
      padding-bottom: env(safe-area-inset-bottom);
      padding-top: env(safe-area-inset-top);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    
    /* Loading Animation */
    .loading-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to top, #F28E47, #214B7A);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease-out;
    }
    
    .breathing-loader {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      animation: breathe 4s infinite ease-in-out;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .loader-text {
      text-align: center;
      font-size: 1.2rem;
      margin-top: 20px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    @keyframes breathe {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.5); }
    }
    
    /* Hide content until loaded */
    .app-container {
      opacity: 0;
      transition: opacity 0.5s ease-in;
    }
    
    /* Header fixed at the top */
    .header {
      position: fixed;
      top: calc(20px + env(safe-area-inset-top));
      left: 0;
      right: 0;
      text-align: center;
      z-index: 10;
    }
    .header h1 {
      font-size: 2.4rem;
      font-weight: 600;
    }
    /* Main Container centered vertically and horizontally */
    .main-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    /* Breathing Circle */
    .breathing-circle {
      width: 300px;
      height: 300px;
      border-radius: 50%;
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transition: transform 1s ease-in-out;
      cursor: default;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Timer */
    .timer {
      font-size: 1.8rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      text-align: center;
      transition: opacity 0.15s ease-in-out;
    }
    
    .timer.fade {
      opacity: 0.3;
    }
    
    .focus-mode .timer {
      opacity: 0;
    }
    
    /* Session Progress Bar */
    .session-progress-container {
      position: fixed;
      bottom: calc(20px + env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%);
      width: 50%;
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .session-progress {
      width: 100%;
      height: 36px; /* Match corner button height */
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .session-progress:hover {
      background: rgba(255, 255, 255, 0.4);
    }
    
    .session-progress-bar {
      height: 100%;
      background: rgba(255, 255, 255, 0.5);
      width: 0%;
      transition: width 1s linear;
    }
    
    .timer-options {
      position: absolute;
      bottom: calc(65px + env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 10px;
      display: none;
      z-index: 30;
    }
    
    .timer-options button {
      background: transparent;
      border: none;
      color: white;
      padding: 8px 15px;
      margin: 0 5px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .timer-options button:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .timer-options button.active {
      background: rgba(255, 255, 255, 0.3);
    }
    /* Bottom Corner Buttons */
    .corner-button {
      position: absolute;
      /* 
         Add the safe-area inset to the bottom offset so they stay above
         the Safari bar. 20px is your usual gap; env(safe-area-inset-bottom) 
         ensures it won't be hidden on iPhones with a home indicator.
      */
      bottom: calc(20px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 12px;
      padding: 8px 14px;
      font-size: 1rem;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    .corner-button:focus {
      outline: 2px solid #fff;
    }
    .corner-button:hover {
      background: rgba(255,255,255,0.4);
    }
    /* Positioning: Technique button at bottom left, Focus button at bottom right */
    #techniqueButton { left: 20px; }
    #focusButton     { right: 20px; }
    /* Focus Mode: Hide header */
    .focus-mode .header {
      display: none;
    }
    /* Technique Panel (dropdown) with transparent background */
    #techniquePanel {
      position: absolute;
      /* 
         Also push it above the safe-area bottom if needed 
         (70px above the button's bottom).
      */
      bottom: calc(70px + env(safe-area-inset-bottom));
      left: 20px;
      background: rgba(255,255,255,0.2);
      color: #fff;
      border-radius: 12px;
      padding: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      display: none;
      z-index: 50;
    }
    #techniquePanel button, #techniquePanel .learn-more {
      background: transparent;
      border: none;
      padding: 6px 10px;
      font-size: 1rem;
      color: #fff;
      text-align: left;
      width: 100%;
      cursor: pointer;
      transition: background 0.3s;
      display: block;
    }
    #techniquePanel button:hover, #techniquePanel .learn-more:hover {
      background: rgba(255,255,255,0.3);
    }
    #techniquePanel .divider {
      height: 1px;
      background: rgba(255,255,255,0.3);
      margin: 5px 0;
    }

    /* Knowledge Section Styles */
    #knowledgeSection {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to top, #F28E47, #214B7A);
      z-index: 100;
      overflow-y: auto;
      padding: calc(20px + env(safe-area-inset-top)) 20px calc(70px + env(safe-area-inset-bottom)) 20px;
    }
    
    .knowledge-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .knowledge-header h1 {
      font-size: 2.4rem;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .knowledge-header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .knowledge-nav {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 25px;
    }
    
    .knowledge-nav button {
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 12px;
      padding: 8px 14px;
      font-size: 1rem;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .knowledge-nav button:hover, .knowledge-nav button.active {
      background: rgba(255,255,255,0.4);
    }
    
    .knowledge-content {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin: 0 auto;
      max-width: 800px;
    }
    
    .technique-info {
      display: none;
    }
    
    .technique-info.active {
      display: block;
    }
    
    .technique-info h2 {
      font-size: 1.8rem;
      margin-bottom: 15px;
    }
    
    .technique-info h3 {
      font-size: 1.3rem;
      margin: 20px 0 10px;
    }
    
    .technique-info p, .technique-info ul, .technique-info ol {
      margin-bottom: 15px;
      line-height: 1.6;
    }
    
    .technique-info ul, .technique-info ol {
      padding-left: 25px;
    }
    
    .back-button {
      position: fixed;
      top: calc(20px + env(safe-area-inset-top));
      left: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 12px;
      padding: 8px 14px;
      font-size: 1rem;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
      z-index: 110;
    }
    
    .back-button:hover {
      background: rgba(255,255,255,0.4);
    }
    
    @media (min-width: 768px) {
      .header h1 { font-size: 3rem; }
      .breathing-circle { width: 350px; height: 350px; }
      .knowledge-header h1 { font-size: 3rem; }
    }
  </style>
</head>
<body>
  <!-- Loading Animation -->
  <div id="loadingContainer" class="loading-container">
    <div>
      <div class="breathing-loader"></div>
      <div class="loader-text">Loading Hagius Breathing...</div>
    </div>
  </div>

  <!-- App Container - hidden until loaded -->
  <div id="appContainer" class="app-container">
    <!-- Header fixed at the top -->
    <div class="header">
      <h1>Hagius Breathing</h1>
    </div>
    
    <!-- Session Progress Bar -->
    <div class="session-progress-container">
      <div id="progressBar" class="session-progress">
        <div id="progressIndicator" class="session-progress-bar"></div>
      </div>
    </div>
    
    <!-- Timer Options - Positioned above progress bar when active -->
    <div id="timerOptions" class="timer-options">
      <button data-duration="2">2 min</button>
      <button data-duration="5" class="active">5 min</button>
      <button data-duration="10">10 min</button>
      <button data-duration="20">20 min</button>
    </div>
    
    <!-- Main Container centered -->
    <div class="main-container">
      <!-- Breathing Circle (always animating) -->
      <div id="breathingCircle" class="breathing-circle" aria-label="Breathing animation">
        <div id="timer" class="timer">
          Start
        </div>
      </div>
    </div>
    
    <!-- Bottom Corner Buttons -->
    <button id="techniqueButton" class="corner-button" aria-label="Select breathing technique">Technique</button>
    <button id="focusButton" class="corner-button" aria-label="Toggle focus mode">Focus</button>
    
    <!-- Technique Panel (dropdown) -->
    <div id="techniquePanel">
      <button data-technique="resonance">Resonance (5.5:5.5)</button>
      <button data-technique="box">Box (4:4:4:4)</button>
      <button data-technique="478">4:7:8</button>
      <button data-technique="physio-sigh">Physiological Sigh</button>
      <div class="divider"></div>
      <a href="#" class="learn-more" id="learnMoreButton">Learn More</a>
    </div>
    
    <!-- Knowledge Section (hidden by default) -->
    <div id="knowledgeSection">
      <button class="back-button" id="backButton">Back</button>
      
      <div class="knowledge-header">
        <h1>Breathing Techniques</h1>
        <p>Learn about the science and benefits behind each technique</p>
      </div>
      
      <div class="knowledge-nav">
        <button class="technique-btn active" data-technique="basics">Basics</button>
        <button class="technique-btn" data-technique="resonance">Resonance</button>
        <button class="technique-btn" data-technique="box">Box</button>
        <button class="technique-btn" data-technique="478">4-7-8</button>
        <button class="technique-btn" data-technique="physio-sigh">Physiological Sigh</button>
      </div>
      
      <div class="knowledge-content">
        <!-- Basics Info -->
        <div id="basics-info" class="technique-info active">
          <h2>Breathing Basics</h2>
          
          <p>Conscious breathing is one of the most powerful tools we have for managing stress, improving focus, and enhancing overall well-being. Understanding how breathing affects your mind and body is the first step in harnessing its potential.</p>
          
          <h3>The Science of Breathing</h3>
          <p>Your breath is the bridge between your conscious and unconscious processes. When you breathe, you activate your autonomic nervous system, which has two branches:</p>
          <ul>
            <li><strong>Sympathetic Nervous System</strong> - Your "fight or flight" response, activated by short, shallow breathing</li>
            <li><strong>Parasympathetic Nervous System</strong> - Your "rest and digest" response, activated by slow, deep breathing</li>
          </ul>
          
          <h3>Common Elements of Breathing Techniques</h3>
          <ul>
            <li><strong>Rate</strong> - How many breath cycles per minute</li>
            <li><strong>Depth</strong> - How deeply you inhale and exhale</li>
            <li><strong>Rhythm</strong> - The pattern of inhalation, holds, and exhalation</li>
            <li><strong>Pathway</strong> - Whether you breathe through your nose or mouth</li>
            <li><strong>Duration</strong> - How long you practice</li>
          </ul>
          
          <h3>Getting Started</h3>
          <p>For beginners, here are some tips to maximize the benefits of breathing practice:</p>
          <ul>
            <li>Start with just 5 minutes daily</li>
            <li>Practice in a comfortable seated position</li>
            <li>Breathe through your nose when possible</li>
            <li>Notice how different techniques make you feel</li>
            <li>Be patient - benefits increase with regular practice</li>
          </ul>
          
          <h3>When to Practice</h3>
          <p>Conscious breathing can be beneficial in many situations:</p>
          <ul>
            <li>First thing in the morning to set a calm tone for the day</li>
            <li>Before important meetings or events to reduce anxiety</li>
            <li>During stressful moments to regain composure</li>
            <li>Before meals to improve digestion</li>
            <li>Before bed to prepare for restful sleep</li>
          </ul>
        </div>
        
        <!-- Resonance Breathing Info -->
        <div id="resonance-info" class="technique-info">
          <h2>Resonance Breathing (5.5:5.5)</h2>
          
          <p>Resonance breathing, also known as coherent breathing, involves breathing at a rate of about 5-6 breaths per minute (inhaling for 5.5 seconds, exhaling for 5.5 seconds). This breathing rate has been found to optimize heart rate variability (HRV) and create resonance in the cardiovascular system.</p>
          
          <h3>How to Practice</h3>
          <ol>
            <li>Find a comfortable seated position with your spine straight</li>
            <li>Breathe gently through your nose</li>
            <li>Inhale slowly for 5 seconds, allowing your abdomen to expand</li>
            <li>Exhale slowly for 5 seconds, allowing your abdomen to fall</li>
            <li>Continue this rhythm for 5-20 minutes</li>
          </ol>
          
          <h3>Benefits</h3>
          <ul>
            <li>Balances the autonomic nervous system</li>
            <li>Increases heart rate variability (a marker of stress resilience)</li>
            <li>Reduces stress and anxiety</li>
            <li>Improves focus and concentration</li>
            <li>May help lower blood pressure</li>
            <li>Enhances overall sense of calm</li>
          </ul>
          
          <h3>The Science</h3>
          <p>The 5-second inhalation and 5-second exhalation cycle (creating about 6 breaths per minute) synchronizes with natural cardiovascular rhythms. This creates a state known as "cardiac coherence" where the heart, respiratory system, and blood pressure oscillations come into alignment. Research conducted at the HeartMath Institute has shown that this synchronized pattern optimizes heart-brain communication and improves cognitive function.</p>
        </div>
        
        <!-- Box Breathing Info -->
        <div id="box-info" class="technique-info">
          <h2>Box Breathing (4:4:4:4)</h2>
          
          <p>Box breathing, also known as square breathing, is a simple technique used to calm the nervous system and improve focus. It gets its name from the equal duration used for inhalation, holding the breath, exhalation, and holding again.</p>
          
          <h3>How to Practice</h3>
          <ol>
            <li>Sit in a comfortable position with your back straight</li>
            <li>Inhale through your nose slowly for 4 seconds</li>
            <li>Hold your breath for 4 seconds</li>
            <li>Exhale slowly through your mouth for 4 seconds</li>
            <li>Hold your breath for 4 seconds</li>
            <li>Repeat the cycle for 5-10 minutes</li>
          </ol>
          
          <h3>Benefits</h3>
          <ul>
            <li>Reduces stress and anxiety</li>
            <li>Improves concentration and mental clarity</li>
            <li>Helps control emotional responses in high-stress situations</li>
            <li>Regulates the autonomic nervous system</li>
            <li>May help with insomnia when practiced before bedtime</li>
          </ul>
          
          <h3>The Science</h3>
          <p>Box breathing activates the parasympathetic nervous system, which is responsible for rest and digestion. By extending the exhale and adding breath holds, this technique increases carbon dioxide levels slightly, which has a calming effect on the brain. Navy SEALs and other military personnel are trained to use box breathing to remain calm in high-stress situations and maintain clear decision-making.</p>
        </div>
        
        <!-- 4-7-8 Breathing Info -->
        <div id="478-info" class="technique-info">
          <h2>4-7-8 Breathing Technique</h2>
          
          <p>The 4-7-8 breathing technique was developed by Dr. Andrew Weil, a Harvard-trained physician, and is based on pranayama, an ancient yogic practice of breath control. It's specifically designed to promote relaxation and help manage stress and anxiety.</p>
          
          <h3>How to Practice</h3>
          <ol>
            <li>Sit in a comfortable position with your back straight</li>
            <li>Place the tip of your tongue against the tissue behind your upper front teeth</li>
            <li>Exhale completely through your mouth, making a whoosh sound</li>
            <li>Close your mouth and inhale quietly through your nose for a count of 4</li>
            <li>Hold your breath for a count of 7</li>
            <li>Exhale completely through your mouth for a count of 8, making the whoosh sound</li>
            <li>This completes one cycle; repeat for a total of 4 cycles</li>
          </ol>
          
          <h3>Benefits</h3>
          <ul>
            <li>Helps with falling asleep</li>
            <li>Reduces anxiety and stress</li>
            <li>May help manage cravings and compulsive behaviors</li>
            <li>Promotes overall relaxation</li>
            <li>May help control anger responses</li>
            <li>Can lower heart rate in moments of acute stress</li>
          </ul>
          
          <h3>The Science</h3>
          <p>The 4-7-8 technique works by forcing the mind and body to focus on regulating the breath, rather than replaying worries. The extended breath hold and long exhale help activate the parasympathetic nervous system, creating a natural tranquilizing effect. The longer exhale compared to inhale helps reduce the fight-or-flight response by reducing heart rate and blood pressure.</p>
        </div>
        
        <!-- Physiological Sigh Info -->
        <div id="physio-sigh-info" class="technique-info">
          <h2>Physiological Sigh</h2>
          
          <p>The physiological sigh is a natural breathing pattern that humans and animals use to restore lung function and regulate stress. It consists of a double inhale followed by a prolonged exhale and has been researched extensively by Dr. Andrew Huberman at Stanford University.</p>
          
          <h3>How to Practice</h3>
          <ol>
            <li>Take a normal inhale through your nose (1 second)</li>
            <li>Immediately follow with a second short inhale to completely fill your lungs (0.25 seconds)</li>
            <li>Exhale slowly through your mouth for about 2 seconds</li>
            <li>Repeat 1-3 times as needed</li>
          </ol>
          
          <h3>Benefits</h3>
          <ul>
            <li>Rapidly reduces anxiety and stress</li>
            <li>Quickly restores normal COâ‚‚ levels in the bloodstream</li>
            <li>Reinflates alveoli (tiny air sacs) in the lungs</li>
            <li>Can provide immediate emotional regulation</li>
            <li>Useful for overcoming acute stress moments</li>
            <li>Can be performed discreetly in any setting</li>
          </ul>
          
          <h3>The Science</h3>
          <p>The physiological sigh is a mechanism built into our respiratory systems to maintain proper lung function. Under stress, small air sacs (alveoli) in our lungs can collapse, reducing oxygen uptake. The double inhale action of the physiological sigh "pops open" these deflated alveoli, while the extended exhale triggers receptors that activate the parasympathetic nervous system. Research from Stanford University has shown that this breathing pattern rapidly decreases stress markers and can shift the nervous system from "fight-or-flight" to a calmer state within 30-60 seconds.</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Audio Cues - Preload for faster response -->
  <audio id="audioInhale" preload="auto"></audio>
  <audio id="audioHold" preload="auto"></audio>
  <audio id="audioExhale" preload="auto"></audio>
  
  <script>
    /************************************
     * 1) Breathing Patterns
     ************************************/
    const patterns = {
      resonance: [
        { label: 'Inhale', duration: 5.5 },
        { label: 'Exhale', duration: 5.5 }
      ],
      box: [
        { label: 'Inhale', duration: 4 },
        { label: 'Hold',   duration: 4 },
        { label: 'Exhale', duration: 4 },
        { label: 'Hold',   duration: 4 }
      ],
      '478': [
        { label: 'Inhale', duration: 4 },
        { label: 'Hold',   duration: 7 },
        { label: 'Exhale', duration: 8 }
      ],
      'physio-sigh': [
        { label: 'Inhale', duration: 1 },
        { label: 'Inhale2', duration: 0.25 },
        { label: 'Exhale', duration: 2 }
      ]
    };
    let currentPattern = patterns.resonance; // default

    /************************************
     * 2) State Variables
     ************************************/
    let currentPhaseIndex = 0;
    let currentPhaseTime  = 0;
    let phaseIntervalId   = null;
    let currentScale      = 1.0;
    let isFocusMode       = false;
    
    // Session timer variables
    let sessionDuration = 5 * 60; // Default: 5 minutes in seconds
    let sessionElapsed = 0;
    let sessionIntervalId = null;
    
    // Audio sources - set programmatically to avoid 404 errors before files are available
    const audioSources = {
      inhale: 'sounds/chime-inhale.mp3',
      hold: 'sounds/chime-hold.mp3',
      exhale: 'sounds/chime-exhale.mp3'
    };

    /************************************
     * 3) Element Caching - for performance
     ************************************/
    let elements = {};
    
    function cacheElements() {
      // Performance optimization: Cache DOM queries
      elements = {
        appContainer: document.getElementById('appContainer'),
        loadingContainer: document.getElementById('loadingContainer'),
        breathingCircle: document.getElementById('breathingCircle'),
        techniqueButton: document.getElementById('techniqueButton'),
        focusButton: document.getElementById('focusButton'),
        techniquePanel: document.getElementById('techniquePanel'),
        learnMoreButton: document.getElementById('learnMoreButton'),
        knowledgeSection: document.getElementById('knowledgeSection'),
        backButton: document.getElementById('backButton'),
        techniqueBtns: document.querySelectorAll('.technique-btn'),
        timerDisplay: document.getElementById('timer'),
        progressBar: document.getElementById('progressBar'),
        progressIndicator: document.getElementById('progressIndicator'),
        timerOptions: document.getElementById('timerOptions'),
        audioInhale: document.getElementById('audioInhale'),
        audioHold: document.getElementById('audioHold'),
        audioExhale: document.getElementById('audioExhale')
      };
      
      // Set audio sources now that the DOM is ready
      elements.audioInhale.src = audioSources.inhale;
      elements.audioHold.src = audioSources.hold;
      elements.audioExhale.src = audioSources.exhale;
    }

    /************************************
     * 4) Breathing Logic
     ************************************/
    function startBreathing() {
      // Start at phase 0 and continuously loop
      currentPhaseIndex = 0;
      startPhase(currentPhaseIndex);
    }
    
    function resetBreathing() {
      // Clear any existing interval and restart cycle with new technique
      clearInterval(phaseIntervalId);
      phaseIntervalId = null;
      currentScale = 1.0;
      startPhase(0);
    }
    
    function startPhase(phaseIndex) {
      const phase = currentPattern[phaseIndex];
      currentPhaseTime = phase.duration;
      playAudioCue(phase.label);
      applyPhaseAnimation(phase.label, phase.duration);
      
      // Add simple fade transition for text
      elements.timerDisplay.classList.add('fade');
      
      setTimeout(() => {
        // Set the appropriate label
        let displayLabel = phase.label;
        if (displayLabel === 'Inhale2') {
          displayLabel = 'Inhale'; // Changed from "Second Inhale" to just "Inhale"
        } else if (displayLabel === 'Hold') {
          displayLabel = 'Hold';
        } else {
          displayLabel = displayLabel.charAt(0).toUpperCase() + displayLabel.slice(1);
        }
        
        elements.timerDisplay.textContent = displayLabel;
        elements.timerDisplay.classList.remove('fade');
      }, 150); // Short delay for fade transition
      
      clearInterval(phaseIntervalId);
      phaseIntervalId = setInterval(() => {
        currentPhaseTime -= 0.1; // Smaller increment for smoother progress
        
        if (currentPhaseTime <= 0) {
          clearInterval(phaseIntervalId);
          const nextIndex = (phaseIndex + 1) % currentPattern.length;
          startPhase(nextIndex);
        }
      }, 100); // 100ms for smoother updates
    }
    
    function applyPhaseAnimation(label, duration) {
      let nextScale = currentScale;
      switch (label.toLowerCase()) {
        case 'inhale': nextScale = 1.5; break;
        case 'inhale2': nextScale = 1.8; break; // Bigger scale for second inhale
        case 'exhale': nextScale = 0.6; break;
        case 'hold':   nextScale = currentScale; break;
        default:       nextScale = 1.0;
      }
      elements.breathingCircle.style.transition = `transform ${duration}s ease-in-out`;
      elements.breathingCircle.style.transform = `scale(${nextScale})`;
      currentScale = nextScale;
    }
    
    function playAudioCue(label) {
      try {
        if (label.toLowerCase() === 'inhale') {
          elements.audioInhale.currentTime = 0;
          elements.audioInhale.play().catch(() => {}); // Catch silent failures on mobile
        } else if (label.toLowerCase() === 'exhale') {
          elements.audioExhale.currentTime = 0;
          elements.audioExhale.play().catch(() => {});
        } else if (label.toLowerCase() === 'hold') {
          elements.audioHold.currentTime = 0;
          elements.audioHold.play().catch(() => {});
        }
      } catch (e) {
        console.log('Audio play error:', e);
      }
    }

    /************************************
     * 5) Session Timer Logic
     ************************************/
    function startSessionTimer() {
      // Clear any existing interval
      if (sessionIntervalId) {
        clearInterval(sessionIntervalId);
      }
      
      // Reset timer
      sessionElapsed = 0;
      updateProgressBar();
      
      // Start new timer
      sessionIntervalId = setInterval(() => {
        sessionElapsed++;
        updateProgressBar();
        
        if (sessionElapsed >= sessionDuration) {
          endSession();
        }
      }, 1000);
    }
    
    function updateProgressBar() {
      const progressPercent = (sessionElapsed / sessionDuration) * 100;
      elements.progressIndicator.style.width = `${progressPercent}%`;
    }
    
    function endSession() {
      clearInterval(sessionIntervalId);
      
      // Reset progress bar
      elements.progressIndicator.style.width = '0%';
      
      // Optional: Add a completion notification
      alert('Breathing session complete!');
    }

    /************************************
     * 6) Event Handlers - Attach after DOM load
     ************************************/
    function attachEventListeners() {
      // Technique Button Toggle
      elements.techniqueButton.addEventListener('click', (e) => {
        e.stopPropagation();
        elements.techniquePanel.style.display = 
          (elements.techniquePanel.style.display === 'block') ? 'none' : 'block';
      });
      
      // Hide technique panel when clicking elsewhere
      document.addEventListener('click', (e) => {
        if (!elements.techniquePanel.contains(e.target) && e.target !== elements.techniqueButton) {
          elements.techniquePanel.style.display = 'none';
        }
      });
      
      // Technique Selection
      Array.from(elements.techniquePanel.querySelectorAll('button')).forEach(btn => {
        btn.addEventListener('click', () => {
          const selected = btn.getAttribute('data-technique');
          currentPattern = patterns[selected];
          elements.techniqueButton.textContent = btn.textContent;
          resetBreathing();
          elements.techniquePanel.style.display = 'none';
        });
      });
      
      // Focus Mode Toggle
      elements.focusButton.addEventListener('click', () => {
        isFocusMode = !isFocusMode;
        document.body.classList.toggle('focus-mode', isFocusMode);
        elements.focusButton.textContent = isFocusMode ? 'Exit Focus' : 'Focus';
      });
      
      // Learn More Button
      elements.learnMoreButton.addEventListener('click', (e) => {
        e.preventDefault();
        elements.knowledgeSection.style.display = 'block';
        elements.techniquePanel.style.display = 'none';
      });
      
      // Back Button in Knowledge Section
      elements.backButton.addEventListener('click', () => {
        elements.knowledgeSection.style.display = 'none';
      });
      
      // Knowledge Section Technique Navigation
      elements.techniqueBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          // Remove active class from all buttons
          elements.techniqueBtns.forEach(b => b.classList.remove('active'));
          // Add active class to clicked button
          btn.classList.add('active');
          
          // Hide all technique info divs
          document.querySelectorAll('.technique-info').forEach(div => {
            div.classList.remove('active');
          });
          
          // Show the selected technique info
          const techniqueId = btn.getAttribute('data-technique');
          const targetInfo = document.getElementById(`${techniqueId}-info`);
          if (targetInfo) {
            targetInfo.classList.add('active');
          } else {
            console.error(`Info element not found for: ${techniqueId}`);
          }
        });
      });
      
      // Progress Bar Click
      elements.progressBar.addEventListener('click', () => {
        elements.timerOptions.style.display = 
          elements.timerOptions.style.display === 'block' ? 'none' : 'block';
      });
      
      // Close timer options when clicking elsewhere
      document.addEventListener('click', (e) => {
        if (!elements.timerOptions.contains(e.target) && e.target !== elements.progressBar) {
          elements.timerOptions.style.display = 'none';
        }
      });
      
      // Timer Options
      document.querySelectorAll('.timer-options button').forEach(btn => {
        btn.addEventListener('click', () => {
          // Update active button
          document.querySelectorAll('.timer-options button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          // Set new duration
          const minutes = parseInt(btn.getAttribute('data-duration'));
          sessionDuration = minutes * 60;
          
          // Restart timer
          startSessionTimer();
          
          // Hide options
          elements.timerOptions.style.display = 'none';
        });
      });
    }

    /************************************
     * 7) Initialization
     ************************************/
    // Load event to initialize the app
    window.addEventListener('DOMContentLoaded', function() {
      // Cache DOM elements for performance
      cacheElements();
      
      // Attach event listeners
      attachEventListeners();
    });
    
    // Replace window.onload with addEventListener for better compatibility
    window.addEventListener('load', function() {
      // Hide loading screen with fade out
      elements.loadingContainer.style.opacity = '0';
      setTimeout(() => {
        elements.loadingContainer.style.display = 'none';
      }, 500);
      
      // Show app content with fade in
      elements.appContainer.style.opacity = '1';
      
      // Start the breathing animation
      startBreathing();
      
      // Start the session timer
      startSessionTimer();
    });
    
    // Add error handling for audio loading
    function setupAudioErrorHandling() {
      [elements.audioInhale, elements.audioHold, elements.audioExhale].forEach(audio => {
        if (audio) {
          audio.addEventListener('error', function() {
            console.log('Audio failed to load:', this.src);
          });
        }
      });
    }
  </script>
</body>
</html>
