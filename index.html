<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Hagius Breathing</title>
  <style>
    /* Reset & Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary-color: #214B7A;
      --secondary-color: #F28E47;
      --white-transparent-light: rgba(255, 255, 255, 0.2);
      --white-transparent-medium: rgba(255, 255, 255, 0.3);
      --white-transparent-bright: rgba(255, 255, 255, 0.4);
      --white-transparent-brighter: rgba(255, 255, 255, 0.5);
      --border-radius: 12px;
      --transition-speed: 0.3s;
      --safe-bottom: calc(20px + env(safe-area-inset-bottom));
      --safe-top: calc(20px + env(safe-area-inset-top));
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(to top, var(--secondary-color), var(--primary-color));
      color: #fff;
      position: relative;
      padding-bottom: env(safe-area-inset-bottom);
      padding-top: env(safe-area-inset-top);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    
    /* Loading Animation */
    .loading-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to top, var(--secondary-color), var(--primary-color));
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease-out;
    }
    
    .breathing-loader {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--white-transparent-light);
      animation: breathe 4s infinite ease-in-out;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    @keyframes breathe {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.5); }
    }
    
    .loader-text {
      text-align: center;
      font-size: 1.2rem;
      margin-top: 20px;
    }
    
    /* Hide content until loaded */
    .app-container {
      opacity: 0;
      transition: opacity 0.5s ease-in;
      height: 100%;
    }
    
    /* Header */
    .header {
      position: fixed;
      top: var(--safe-top);
      left: 0;
      right: 0;
      text-align: center;
      z-index: 10;
      transition: opacity 0.3s ease;
    }
    
    .header h1 {
      font-size: 2.4rem;
      font-weight: 600;
    }
    
    /* Main Container */
    .main-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    
    /* Breathing Circle */
    .breathing-circle {
      width: 300px;
      height: 300px;
      border-radius: 50%;
      background: radial-gradient(circle at 50% 50%, var(--white-transparent-light), var(--white-transparent-light));
      will-change: transform;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Timer */
    .timer {
      font-size: 1.8rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
      text-align: center;
      transition: opacity 0.15s ease-in-out;
    }
    
    .timer.fade {
      opacity: 0.3;
    }
    
    .focus-mode .timer {
      opacity: 0;
    }
    
    /* Session Progress Bar */
    .session-progress-container {
      position: fixed;
      bottom: var(--safe-bottom);
      left: 50%;
      transform: translateX(-50%);
      width: 50%;
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .session-progress {
      width: 100%;
      height: 36px;
      background: var(--white-transparent-light);
      border-radius: var(--border-radius);
      overflow: hidden;
      cursor: pointer;
      transition: background var(--transition-speed);
      position: relative;
    }
    
    .session-progress:hover {
      background: var(--white-transparent-bright);
    }
    
    .session-progress-bar {
      height: 100%;
      background: var(--white-transparent-brighter);
      width: 0%;
      transition: width 1s linear;
      position: absolute;
      left: 0;
      top: 0;
      z-index: 1;
    }
    
    .remaining-time {
      position: absolute;
      font-size: 1rem;
      font-weight: 500;
      color: white;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
      transition: opacity 0.3s ease;
    }
    
    .focus-mode .remaining-time {
      opacity: 0;
      pointer-events: none;
    }
    
    /* Timer Options */
    .timer-options {
      position: absolute;
      bottom: calc(65px + env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%);
      background: var(--white-transparent-light);
      border-radius: var(--border-radius);
      padding: 10px;
      display: none;
      z-index: 30;
    }
    
    .timer-options button {
      background: transparent;
      border: none;
      color: white;
      padding: 8px 15px;
      margin: 0 5px;
      border-radius: 8px;
      cursor: pointer;
      transition: background var(--transition-speed);
    }
    
    .timer-options button:hover {
      background: var(--white-transparent-medium);
    }
    
    .timer-options button.active {
      background: var(--white-transparent-medium);
    }
    
    /* Corner Buttons */
    .corner-button {
      position: absolute;
      bottom: var(--safe-bottom);
      background: var(--white-transparent-light);
      border: none;
      border-radius: var(--border-radius);
      padding: 8px 14px;
      font-size: 1rem;
      color: #fff;
      cursor: pointer;
      transition: background var(--transition-speed);
    }
    
    .corner-button:focus {
      outline: 2px solid #fff;
    }
    
    .corner-button:hover {
      background: var(--white-transparent-bright);
    }
    
    #techniqueButton { left: 20px; }
    #focusButton { right: 20px; }
    
    /* Focus Mode */
    .focus-mode .header {
      opacity: 0;
      pointer-events: none;
    }
    
    /* Technique Panel */
    #techniquePanel {
      position: absolute;
      bottom: calc(70px + env(safe-area-inset-bottom));
      left: 20px;
      background: var(--white-transparent-light);
      color: #fff;
      border-radius: var(--border-radius);
      padding: 8px;
      display: none;
      z-index: 50;
    }
    
    #techniquePanel button, #techniquePanel .learn-more {
      background: transparent;
      border: none;
      padding: 6px 10px;
      font-size: 1rem;
      color: #fff;
      text-align: left;
      width: 100%;
      cursor: pointer;
      transition: background var(--transition-speed);
      display: block;
    }
    
    #techniquePanel button:hover, #techniquePanel .learn-more:hover {
      background: var(--white-transparent-medium);
    }
    
    #techniquePanel .divider {
      height: 1px;
      background: var(--white-transparent-medium);
      margin: 5px 0;
    }
    
    /* Knowledge Section */
    #knowledgeSection {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to top, var(--secondary-color), var(--primary-color));
      z-index: 100;
      overflow-y: auto;
      padding: var(--safe-top) 20px calc(70px + env(safe-area-inset-bottom)) 20px;
    }
    
    .knowledge-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .knowledge-header h1 {
      font-size: 2.4rem;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .knowledge-header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .knowledge-nav {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 25px;
    }
    
    .knowledge-nav button {
      background: var(--white-transparent-light);
      border: none;
      border-radius: var(--border-radius);
      padding: 8px 14px;
      font-size: 1rem;
      color: #fff;
      cursor: pointer;
      transition: background var(--transition-speed);
    }
    
    .knowledge-nav button:hover, .knowledge-nav button.active {
      background: var(--white-transparent-bright);
    }
    
    .knowledge-content {
      background: var(--white-transparent-light);
      border-radius: var(--border-radius);
      padding: 20px;
      margin: 0 auto;
      max-width: 800px;
    }
    
    .technique-info {
      display: none;
    }
    
    .technique-info.active {
      display: block;
    }
    
    .technique-info h2 {
      font-size: 1.8rem;
      margin-bottom: 15px;
    }
    
    .technique-info h3 {
      font-size: 1.3rem;
      margin: 20px 0 10px;
    }
    
    .technique-info p, .technique-info ul, .technique-info ol {
      margin-bottom: 15px;
      line-height: 1.6;
    }
    
    .technique-info ul, .technique-info ol {
      padding-left: 25px;
    }
    
    .back-button {
      position: fixed;
      top: var(--safe-top);
      left: 20px;
      background: var(--white-transparent-light);
      border: none;
      border-radius: var(--border-radius);
      padding: 8px 14px;
      font-size: 1rem;
      color: #fff;
      cursor: pointer;
      transition: background var(--transition-speed);
      z-index: 110;
    }
    
    .back-button:hover {
      background: var(--white-transparent-bright);
    }
    
    /* Responsive Design */
    @media (min-width: 768px) {
      .header h1 { font-size: 3rem; }
      .breathing-circle { width: 350px; height: 350px; }
      .knowledge-header h1 { font-size: 3rem; }
    }
    
    @media (max-width: 480px) {
      .session-progress-container { width: 80%; }
      .breathing-circle { width: 250px; height: 250px; }
    }
  </style>
</head>
<body>
  <!-- Loading Animation -->
  <div id="loadingContainer" class="loading-container">
    <div>
      <div class="breathing-loader"></div>
      <div class="loader-text">Loading Hagius Breathing...</div>
    </div>
  </div>

  <!-- App Container - hidden until loaded -->
  <div id="appContainer" class="app-container">
    <!-- Header fixed at the top -->
    <div class="header">
      <h1>Hagius Breathing</h1>
    </div>
    
    <!-- Session Progress Bar -->
    <div class="session-progress-container">
      <div id="progressBar" class="session-progress">
        <div id="progressIndicator" class="session-progress-bar"></div>
        <div id="remainingTime" class="remaining-time">5:00</div>
      </div>
    </div>
    
    <!-- Timer Options - Positioned above progress bar when active -->
    <div id="timerOptions" class="timer-options">
      <button data-duration="2">2 min</button>
      <button data-duration="5" class="active">5 min</button>
      <button data-duration="10">10 min</button>
      <button data-duration="20">20 min</button>
    </div>
    
    <!-- Main Container centered -->
    <div class="main-container">
      <!-- Breathing Circle (always animating) -->
      <div id="breathingCircle" class="breathing-circle" aria-label="Breathing animation">
        <div id="timer" class="timer">
          Start
        </div>
      </div>
    </div>
    
    <!-- Bottom Corner Buttons -->
    <button id="techniqueButton" class="corner-button" aria-label="Select breathing technique">Technique</button>
    <button id="focusButton" class="corner-button" aria-label="Toggle focus mode">Focus</button>
    <button id="hapticButton" class="corner-button" aria-label="Toggle haptic feedback" style="bottom: calc(70px + env(safe-area-inset-bottom)); right: 20px;">Haptic On</button>
    
    <!-- Technique Panel (dropdown) -->
    <div id="techniquePanel">
      <button data-technique="resonance">Resonant Breathing</button>
      <button data-technique="box">Box Breathing</button>
      <button data-technique="478">4-7-8 Breathing</button>
      <button data-technique="physio-sigh">Physiological Sigh</button>
      <div class="divider"></div>
      <a href="#" class="learn-more" id="learnMoreButton">Learn More</a>
    </div>
    
    <!-- Knowledge Section (hidden by default) -->
    <div id="knowledgeSection">
      <button class="back-button" id="backButton">Back</button>
      
      <div class="knowledge-header">
        <h1>Breathing Techniques</h1>
        <p>Learn about the science and benefits behind each technique</p>
      </div>
      
      <div class="knowledge-nav">
        <button class="technique-btn active" data-technique="basics">Basics</button>
        <button class="technique-btn" data-technique="resonance">Resonance</button>
        <button class="technique-btn" data-technique="box">Box</button>
        <button class="technique-btn" data-technique="478">4-7-8</button>
        <button class="technique-btn" data-technique="physio-sigh">Physiological Sigh</button>
      </div>
      
      <div class="knowledge-content">
        <!-- Basics Info -->
        <div id="basics-info" class="technique-info active">
          <h2>Breathing Basics</h2>
          
          <p>Conscious breathing is one of the most powerful tools we have for managing stress, improving focus, and enhancing overall well-being. Understanding how breathing affects your mind and body is the first step in harnessing its potential.</p>
          
          <h3>The Science of Breathing</h3>
          <p>Your breath is the bridge between your conscious and unconscious processes. When you breathe, you activate your autonomic nervous system, which has two branches:</p>
          <ul>
            <li><strong>Sympathetic Nervous System</strong> - Your "fight or flight" response, activated by short, shallow breathing</li>
            <li><strong>Parasympathetic Nervous System</strong> - Your "rest and digest" response, activated by slow, deep breathing</li>
          </ul>
          
          <h3>Common Elements of Breathing Techniques</h3>
          <ul>
            <li><strong>Rate</strong> - How many breath cycles per minute</li>
            <li><strong>Depth</strong> - How deeply you inhale and exhale</li>
            <li><strong>Rhythm</strong> - The pattern of inhalation, holds, and exhalation</li>
            <li><strong>Pathway</strong> - Whether you breathe through your nose or mouth</li>
            <li><strong>Duration</strong> - How long you practice</li>
          </ul>
          
          <h3>Getting Started</h3>
          <p>For beginners, here are some tips to maximize the benefits of breathing practice:</p>
          <ul>
            <li>Start with just 5 minutes daily</li>
            <li>Practice in a comfortable seated position</li>
            <li>Breathe through your nose when possible</li>
            <li>Notice how different techniques make you feel</li>
            <li>Be patient - benefits increase with regular practice</li>
          </ul>
          
          <h3>When to Practice</h3>
          <p>Conscious breathing can be beneficial in many situations:</p>
          <ul>
            <li>First thing in the morning to set a calm tone for the day</li>
            <li>Before important meetings or events to reduce anxiety</li>
            <li>During stressful moments to regain composure</li>
            <li>Before meals to improve digestion</li>
            <li>Before bed to prepare for restful sleep</li>
          </ul>
        </div>
        
        <!-- Resonance Breathing Info -->
        <div id="resonance-info" class="technique-info">
          <h2>Resonant Breathing</h2>
          
          <p>Resonance breathing, also known as coherent breathing, involves breathing at a rate of about 5-6 breaths per minute (inhaling for 5.5 seconds, exhaling for 5.5 seconds). This breathing rate has been found to optimize heart rate variability (HRV) and create resonance in the cardiovascular system.</p>
          
          <h3>How to Practice</h3>
          <ol>
            <li>Find a comfortable seated position with your spine straight</li>
            <li>Breathe gently through your nose</li>
            <li>Inhale slowly for 5 seconds, allowing your abdomen to expand</li>
            <li>Exhale slowly for 5 seconds, allowing your abdomen to fall</li>
            <li>Continue this rhythm for 5-20 minutes</li>
          </ol>
          
          <h3>Benefits</h3>
          <ul>
            <li>Balances the autonomic nervous system</li>
            <li>Increases heart rate variability (a marker of stress resilience)</li>
            <li>Reduces stress and anxiety</li>
            <li>Improves focus and concentration</li>
            <li>May help lower blood pressure</li>
            <li>Enhances overall sense of calm</li>
          </ul>
          
          <h3>The Science</h3>
          <p>The 5-second inhalation and 5-second exhalation cycle (creating about 6 breaths per minute) synchronizes with natural cardiovascular rhythms. This creates a state known as "cardiac coherence" where the heart, respiratory system, and blood pressure oscillations come into alignment. Research conducted at the HeartMath Institute has shown that this synchronized pattern optimizes heart-brain communication and improves cognitive function.</p>
        </div>
        
        <!-- Box Breathing Info -->
        <div id="box-info" class="technique-info">
          <h2>Box Breathing</h2>
          
          <p>Box breathing, also known as square breathing, is a simple technique used to calm the nervous system and improve focus. It gets its name from the equal duration used for inhalation, holding the breath, exhalation, and holding again.</p>
          
          <h3>How to Practice</h3>
          <ol>
            <li>Sit in a comfortable position with your back straight</li>
            <li>Inhale through your nose slowly for 4 seconds</li>
            <li>Hold your breath for 4 seconds</li>
            <li>Exhale slowly through your mouth for 4 seconds</li>
            <li>Hold your breath for 4 seconds</li>
            <li>Repeat the cycle for 5-10 minutes</li>
          </ol>
          
          <h3>Benefits</h3>
          <ul>
            <li>Reduces stress and anxiety</li>
            <li>Improves concentration and mental clarity</li>
            <li>Helps control emotional responses in high-stress situations</li>
            <li>Regulates the autonomic nervous system</li>
            <li>May help with insomnia when practiced before bedtime</li>
          </ul>
          
          <h3>The Science</h3>
          <p>Box breathing activates the parasympathetic nervous system, which is responsible for rest and digestion. By extending the exhale and adding breath holds, this technique increases carbon dioxide levels slightly, which has a calming effect on the brain. Navy SEALs and other military personnel are trained to use box breathing to remain calm in high-stress situations and maintain clear decision-making.</p>
        </div>
        
        <!-- 4-7-8 Breathing Info -->
        <div id="478-info" class="technique-info">
          <h2>4-7-8 Breathing</h2>
          
          <p>The 4-7-8 breathing technique was developed by Dr. Andrew Weil, a Harvard-trained physician, and is based on pranayama, an ancient yogic practice of breath control. It's specifically designed to promote relaxation and help manage stress and anxiety.</p>
          
          <h3>How to Practice</h3>
          <ol>
            <li>Sit in a comfortable position with your back straight</li>
            <li>Place the tip of your tongue against the tissue behind your upper front teeth</li>
            <li>Exhale completely through your mouth, making a whoosh sound</li>
            <li>Close your mouth and inhale quietly through your nose for a count of 4</li>
            <li>Hold your breath for a count of 7</li>
            <li>Exhale completely through your mouth for a count of 8, making the whoosh sound</li>
            <li>This completes one cycle; repeat for a total of 4 cycles</li>
          </ol>
          
          <h3>Benefits</h3>
          <ul>
            <li>Helps with falling asleep</li>
            <li>Reduces anxiety and stress</li>
            <li>May help manage cravings and compulsive behaviors</li>
            <li>Promotes overall relaxation</li>
            <li>May help control anger responses</li>
            <li>Can lower heart rate in moments of acute stress</li>
          </ul>
          
          <h3>The Science</h3>
          <p>The 4-7-8 technique works by forcing the mind and body to focus on regulating the breath, rather than replaying worries. The extended breath hold and long exhale help activate the parasympathetic nervous system, creating a natural tranquilizing effect. The longer exhale compared to inhale helps reduce the fight-or-flight response by reducing heart rate and blood pressure.</p>
        </div>
        
        <!-- Physiological Sigh Info -->
        <div id="physio-sigh-info" class="technique-info">
          <h2>Physiological Sigh</h2>
          
          <p>The physiological sigh is a natural breathing pattern that humans and animals use to restore lung function and regulate stress. It consists of a double inhale followed by a prolonged exhale and has been researched extensively by Dr. Andrew Huberman at Stanford University.</p>
          
          <h3>How to Practice</h3>
          <ol>
            <li>Take a normal inhale through your nose (1 second)</li>
            <li>Immediately follow with a second short inhale to completely fill your lungs (0.25 seconds)</li>
            <li>Exhale slowly through your mouth for about 2 seconds</li>
            <li>Repeat 1-3 times as needed</li>
          </ol>
          
          <h3>Benefits</h3>
          <ul>
            <li>Rapidly reduces anxiety and stress</li>
            <li>Quickly restores normal COâ‚‚ levels in the bloodstream</li>
            <li>Reinflates alveoli (tiny air sacs) in the lungs</li>
            <li>Can provide immediate emotional regulation</li>
            <li>Useful for overcoming acute stress moments</li>
            <li>Can be performed discreetly in any setting</li>
          </ul>
          
          <h3>The Science</h3>
          <p>The physiological sigh is a mechanism built into our respiratory systems to maintain proper lung function. Under stress, small air sacs (alveoli) in our lungs can collapse, reducing oxygen uptake. The double inhale action of the physiological sigh "pops open" these deflated alveoli, while the extended exhale triggers receptors that activate the parasympathetic nervous system. Research from Stanford University has shown that this breathing pattern rapidly decreases stress markers and can shift the nervous system from "fight-or-flight" to a calmer state within 30-60 seconds.</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Audio Cues - Preload for faster response -->
  <audio id="audioInhale" preload="auto"></audio>
  <audio id="audioHold" preload="auto"></audio>
  <audio id="audioExhale" preload="auto"></audio>
  
  <script>
    /**
     * Hagius Breathing App
     * Optimized JavaScript with improved performance, error handling, and organization
     */
    
    // Immediately-invoked function expression (IIFE) to encapsulate our code
    (function() {
      // CONSTANTS
      const AUDIO_SOURCES = {
        inhale: 'sounds/chime-inhale.mp3',
        hold: 'sounds/chime-hold.mp3',
        exhale: 'sounds/chime-exhale.mp3'
      };
      
      // HAPTIC PATTERNS (milliseconds)
      const HAPTIC_PATTERNS = {
        inhale: [100, 50, 100],     // Short pulse, pause, short pulse
        hold: [50],                  // Very short single vibration
        exhale: [200],               // Longer single vibration
        inhale2: [50, 30, 100],      // Special pattern for second inhale in physio-sigh
        sessionEnd: [100, 100, 100, 100, 300] // Pattern for session completion
      };
      
      const BREATHING_PATTERNS = {
        resonance: [
          { label: 'Inhale', duration: 5.5 },
          { label: 'Exhale', duration: 5.5 }
        ],
        box: [
          { label: 'Inhale', duration: 4 },
          { label: 'Hold',   duration: 4 },
          { label: 'Exhale', duration: 4 },
          { label: 'Hold',   duration: 4 }
        ],
        '478': [
          { label: 'Inhale', duration: 4 },
          { label: 'Hold',   duration: 7 },
          { label: 'Exhale', duration: 8 }
        ],
        'physio-sigh': [
          { label: 'Inhale', duration: 1 },
          { label: 'Inhale2', duration: 0.25 },
          { label: 'Exhale', duration: 2 }
        ]
      };
      
      // APP STATE
      const state = {
        currentPattern: BREATHING_PATTERNS.resonance,
        currentPhaseIndex: 0,
        currentPhaseTime: 0,
        phaseIntervalId: null,
        currentScale: 1.0,
        isFocusMode: false,
        sessionDuration: 5 * 60, // Default: 5 minutes in seconds
        sessionElapsed: 0,
        sessionIntervalId: null,
        isAudioReady: false,
        isVibrationSupported: 'vibrate' in navigator,
        hapticEnabled: true, // Default to enabled, can be toggled
        elements: {} // Will store cached DOM elements
      };
      
      // EVENT HANDLERS
      const handlers = {
        toggleTechniquePanel: (e) => {
          e.stopPropagation();
          const panel = state.elements.techniquePanel;
          panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
        },
        
        selectTechnique: (btn) => {
          const selected = btn.getAttribute('data-technique');
          state.currentPattern = BREATHING_PATTERNS[selected];
          state.elements.techniqueButton.textContent = btn.textContent;
          resetBreathing();
          state.elements.techniquePanel.style.display = 'none';
        },
        
        toggleFocusMode: () => {
          state.isFocusMode = !state.isFocusMode;
          document.body.classList.toggle('focus-mode', state.isFocusMode);
          state.elements.focusButton.textContent = state.isFocusMode ? 'Exit Focus' : 'Focus';
        },
        
        showKnowledgeSection: (e) => {
          e.preventDefault();
          state.elements.knowledgeSection.style.display = 'block';
          state.elements.techniquePanel.style.display = 'none';
        },
        
        hideKnowledgeSection: () => {
          state.elements.knowledgeSection.style.display = 'none';
        },
        
        selectTechniqueInfo: (btn) => {
          // Remove active class from all buttons
          state.elements.techniqueBtns.forEach(b => b.classList.remove('active'));
          // Add active class to clicked button
          btn.classList.add('active');
          
          // Hide all technique info divs
          document.querySelectorAll('.technique-info').forEach(div => {
            div.classList.remove('active');
          });
          
          // Show the selected technique info
          const techniqueId = btn.getAttribute('data-technique');
          const targetInfo = document.getElementById(`${techniqueId}-info`);
          if (targetInfo) {
            targetInfo.classList.add('active');
          } else {
            console.error(`Info element not found for: ${techniqueId}`);
          }
        },
        
        toggleTimerOptions: () => {
          const timerOptions = state.elements.timerOptions;
          timerOptions.style.display = (timerOptions.style.display === 'block') ? 'none' : 'block';
        },
        
        selectTimerOption: (btn) => {
          // Update active button
          document.querySelectorAll('.timer-options button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          // Set new duration
          const minutes = parseInt(btn.getAttribute('data-duration'));
          state.sessionDuration = minutes * 60;
          
          // Update the display immediately
          updateRemainingTimeDisplay();
          
          // Restart timer
          startSessionTimer();
          
          // Hide options
          state.elements.timerOptions.style.display = 'none';
        },
        
        // Dismiss panels when clicking outside
        handleDocumentClick: (e) => {
          // Technique panel
          if (!state.elements.techniquePanel.contains(e.target) && 
              e.target !== state.elements.techniqueButton) {
            state.elements.techniquePanel.style.display = 'none';
          }
          
          // Timer options
          if (!state.elements.timerOptions.contains(e.target) && 
              e.target !== state.elements.progressBar) {
            state.elements.timerOptions.style.display = 'none';
          }
        }
      };
      
      // CORE FUNCTIONS
      function cacheElements() {
        // Cache DOM elements for performance
        state.elements = {
          appContainer: document.getElementById('appContainer'),
          loadingContainer: document.getElementById('loadingContainer'),
          breathingCircle: document.getElementById('breathingCircle'),
          techniqueButton: document.getElementById('techniqueButton'),
          focusButton: document.getElementById('focusButton'),
          hapticButton: document.getElementById('hapticButton'),
          techniquePanel: document.getElementById('techniquePanel'),
          learnMoreButton: document.getElementById('learnMoreButton'),
          knowledgeSection: document.getElementById('knowledgeSection'),
          backButton: document.getElementById('backButton'),
          techniqueBtns: document.querySelectorAll('.technique-btn'),
          timerDisplay: document.getElementById('timer'),
          progressBar: document.getElementById('progressBar'),
          progressIndicator: document.getElementById('progressIndicator'),
          timerOptions: document.getElementById('timerOptions'),
          remainingTime: document.getElementById('remainingTime'),
          audioInhale: document.getElementById('audioInhale'),
          audioHold: document.getElementById('audioHold'),
          audioExhale: document.getElementById('audioExhale')
        };
      }
      
      function initializeAudio() {
        // Set audio sources
        const audioElements = [
          { element: state.elements.audioInhale, src: AUDIO_SOURCES.inhale },
          { element: state.elements.audioHold, src: AUDIO_SOURCES.hold },
          { element: state.elements.audioExhale, src: AUDIO_SOURCES.exhale }
        ];
        
        // Load audio and handle errors
        let loadedCount = 0;
        audioElements.forEach(({element, src}) => {
          if (element) {
            element.src = src;
            element.addEventListener('canplaythrough', () => {
              loadedCount++;
              if (loadedCount === audioElements.length) {
                state.isAudioReady = true;
              }
            }, { once: true });
            
            element.addEventListener('error', () => {
              console.warn(`Failed to load audio: ${src}`);
              // Increment counter even if failed so we don't block loading
              loadedCount++;
              if (loadedCount === audioElements.length) {
                state.isAudioReady = true;
              }
            });
          }
        });
      }
      
      function attachEventListeners() {
        // Technique Button Toggle
        state.elements.techniqueButton.addEventListener('click', handlers.toggleTechniquePanel);
        
        // Hide panels when clicking elsewhere
        document.addEventListener('click', handlers.handleDocumentClick);
        
        // Technique Selection
        const techniqueBtns = state.elements.techniquePanel.querySelectorAll('button');
        techniqueBtns.forEach(btn => {
          btn.addEventListener('click', () => handlers.selectTechnique(btn));
        });
        
        // Focus Mode Toggle
        state.elements.focusButton.addEventListener('click', handlers.toggleFocusMode);
        
        // Haptic Feedback Toggle
        const hapticButton = document.getElementById('hapticButton');
        if (hapticButton) {
          hapticButton.addEventListener('click', () => {
            state.hapticEnabled = !state.hapticEnabled;
            hapticButton.textContent = state.hapticEnabled ? 'Haptic On' : 'Haptic Off';
            
            // Provide feedback when turning on
            if (state.hapticEnabled && state.isVibrationSupported) {
              navigator.vibrate(50); // Short vibration to confirm
            }
          });
          
          // Hide haptic button if vibration is not supported
          if (!state.isVibrationSupported) {
            hapticButton.style.display = 'none';
          }
        }
        
        // Learn More Button
        state.elements.learnMoreButton.addEventListener('click', handlers.showKnowledgeSection);
        
        // Back Button in Knowledge Section
        state.elements.backButton.addEventListener('click', handlers.hideKnowledgeSection);
        
        // Knowledge Section Technique Navigation
        state.elements.techniqueBtns.forEach(btn => {
          btn.addEventListener('click', () => handlers.selectTechniqueInfo(btn));
        });
        
        // Progress Bar Click
        state.elements.progressBar.addEventListener('click', handlers.toggleTimerOptions);
        
        // Timer Options
        const timerOptionBtns = document.querySelectorAll('.timer-options button');
        timerOptionBtns.forEach(btn => {
          btn.addEventListener('click', () => handlers.selectTimerOption(btn));
        });
      }
      
      // BREATHING CONTROL FUNCTIONS
      function startBreathing() {
        state.currentPhaseIndex = 0;
        startPhase(state.currentPhaseIndex);
      }
      
      function resetBreathing() {
        clearInterval(state.phaseIntervalId);
        state.phaseIntervalId = null;
        state.currentScale = 1.0;
        startPhase(0);
      }
      
      function startPhase(phaseIndex) {
        const phase = state.currentPattern[phaseIndex];
        state.currentPhaseIndex = phaseIndex;
        state.currentPhaseTime = phase.duration;
        
        playAudioCue(phase.label);
        applyPhaseAnimation(phase.label, phase.duration);
        
        // Add simple fade transition for text
        state.elements.timerDisplay.classList.add('fade');
        
        setTimeout(() => {
          // Set the appropriate label
          let displayLabel = phase.label;
          if (displayLabel === 'Inhale2') {
            displayLabel = 'Inhale';
          } else if (displayLabel === 'Hold') {
            displayLabel = 'Hold';
          } else {
            displayLabel = displayLabel.charAt(0).toUpperCase() + displayLabel.slice(1);
          }
          
          state.elements.timerDisplay.textContent = displayLabel;
          state.elements.timerDisplay.classList.remove('fade');
        }, 150); // Short delay for fade transition
        
        clearInterval(state.phaseIntervalId);
        state.phaseIntervalId = setInterval(() => {
          state.currentPhaseTime -= 0.1; // Smaller increment for smoother progress
          
          if (state.currentPhaseTime <= 0) {
            clearInterval(state.phaseIntervalId);
            const nextIndex = (state.currentPhaseIndex + 1) % state.currentPattern.length;
            startPhase(nextIndex);
          }
        }, 100); // 100ms for smoother updates
      }
      
      function applyPhaseAnimation(label, duration) {
        let nextScale = state.currentScale;
        switch (label.toLowerCase()) {
          case 'inhale': nextScale = 1.5; break;
          case 'inhale2': nextScale = 1.8; break; // Bigger scale for second inhale
          case 'exhale': nextScale = 0.6; break;
          case 'hold':   nextScale = state.currentScale; break;
          default:       nextScale = 1.0;
        }
        
        const circle = state.elements.breathingCircle;
        circle.style.transition = `transform ${duration}s ease-in-out`;
        circle.style.transform = `scale(${nextScale})`;
        state.currentScale = nextScale;
      }
      
      function playAudioCue(label) {
        if (!state.isAudioReady) return;
        
        try {
          let audioElement = null;
          
          if (label.toLowerCase() === 'inhale' || label.toLowerCase() === 'inhale2') {
            audioElement = state.elements.audioInhale;
          } else if (label.toLowerCase() === 'exhale') {
            audioElement = state.elements.audioExhale;
          } else if (label.toLowerCase() === 'hold') {
            audioElement = state.elements.audioHold;
          }
          
          if (audioElement) {
            audioElement.currentTime = 0;
            
            // Create a promise to handle play completion more robustly
            const playPromise = audioElement.play();
            
            if (playPromise !== undefined) {
              playPromise.catch(error => {
                // Auto-play was prevented - common on mobile
                console.warn('Audio playback prevented:', error);
              });
            }
          }
          
          // Trigger haptic feedback
          triggerHapticFeedback(label.toLowerCase());
        } catch (e) {
          console.error('Audio play error:', e);
        }
      }
      
      function triggerHapticFeedback(phaseLabel) {
        // Skip if vibration is not supported or disabled
        if (!state.isVibrationSupported || !state.hapticEnabled) return;
        
        try {
          // Get the appropriate vibration pattern
          const pattern = HAPTIC_PATTERNS[phaseLabel] || [];
          
          if (pattern.length > 0) {
            navigator.vibrate(pattern);
          }
        } catch (e) {
          console.warn('Haptic feedback error:', e);
          // Disable haptics if there's an error to prevent further errors
          state.hapticEnabled = false;
        }
      }
      
      // SESSION TIMER FUNCTIONS
      function startSessionTimer() {
        // Clear any existing interval
        if (state.sessionIntervalId) {
          clearInterval(state.sessionIntervalId);
        }
        
        // Reset timer
        state.sessionElapsed = 0;
        updateProgressBar();
        
        // Start new timer
        state.sessionIntervalId = setInterval(() => {
          state.sessionElapsed++;
          updateProgressBar();
          
          if (state.sessionElapsed >= state.sessionDuration) {
            endSession();
          }
        }, 1000);
      }
      
      function updateProgressBar() {
        const progressPercent = (state.sessionElapsed / state.sessionDuration) * 100;
        state.elements.progressIndicator.style.width = `${progressPercent}%`;
        
        // Update remaining time display
        updateRemainingTimeDisplay();
      }
      
      function updateRemainingTimeDisplay() {
        if (!state.elements.remainingTime) return;
        
        const remainingSeconds = state.sessionDuration - state.sessionElapsed;
        const minutes = Math.floor(remainingSeconds / 60);
        const seconds = remainingSeconds % 60;
        
        // Format as MM:SS with leading zeros
        const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        state.elements.remainingTime.textContent = formattedTime;
      }
      
      function endSession() {
        clearInterval(state.sessionIntervalId);
        state.sessionIntervalId = null;
        
        // Reset progress bar with animation
        state.elements.progressIndicator.style.transition = 'width 0.5s ease-out';
        state.elements.progressIndicator.style.width = '100%';
        
        // Trigger haptic session completion pattern
        if (state.isVibrationSupported && state.hapticEnabled) {
          navigator.vibrate(HAPTIC_PATTERNS.sessionEnd);
        }
        
        setTimeout(() => {
          state.elements.progressIndicator.style.transition = 'width 1s linear';
          state.elements.progressIndicator.style.width = '0%';
          
          // Use a more user-friendly notification system
          // For now, we'll keep the alert for simplicity
          setTimeout(() => {
            // Notify user
            alert('Breathing session complete!');
            // Restart the session after completion
            startSessionTimer();
          }, 500);
        }, 1000);
      }
      
      // INITIALIZATION
      function init() {
        cacheElements();
        initializeAudio();
        attachEventListeners();
        
        // When fully loaded
        window.addEventListener('load', () => {
          // Fade out loading screen
          state.elements.loadingContainer.style.opacity = '0';
          setTimeout(() => {
            state.elements.loadingContainer.style.display = 'none';
          }, 500);
          
          // Show app content with fade in
          state.elements.appContainer.style.opacity = '1';
          
          // Start the breathing animation
          startBreathing();
          
          // Start the session timer
          startSessionTimer();
        });
      }
      
      // Initialize the app when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
